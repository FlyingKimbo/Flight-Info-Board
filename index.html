<!DOCTYPE html>
<html>
<head>
<title>Flight Status</title>
<script>
document.addEventListener("DOMContentLoaded", function() {
    let initialETE = -1;

    function fetchInitialETE() {
        fetch('https://raw.githubusercontent.com/FlyingKimbo/Flight-Info-Board/main/Flight_Data/ETE_seconds_initial.txt')
            .then(response => response.text())
            .then(initialData => {
                initialETE = parseInt(initialData.trim());
                console.log('Initial ETE:', initialETE);
                if (initialETE === -1) {
                    console.log('ETE evaluation disabled.');
                } else if (isNaN(initialETE) || initialETE <= 0) {
                    console.error('Invalid initial ETE value.');
                    initialETE = -1; // Ensure we don't use invalid initial values
                } else {
                    updateETEbars();
                }
            })
            .catch(error => {
                console.error('Error fetching initial ETE data:', error);
            });
    }

    function updateETEbars() {
        if (initialETE === -1) {
            return;
        }
        fetch('https://raw.githubusercontent.com/FlyingKimbo/Flight-Info-Board/main/Flight_Data/ETE_seconds.txt')
            .then(response => response.text())
            .then(data => {
                const eteData = data.split('\n').map(line => parseInt(line.trim())).filter(line => !isNaN(line));
                const eteBar = document.getElementById('ete-bar');
                if (eteBar && eteData.length > 0) {
                    const ete = eteData[0]; // Assuming the first line corresponds to the ETE value
                    console.log('Current ETE:', ete);

                    if (ete === -1) {
                        eteBar.style.width = '100%';
                        eteBar.style.opacity = 0;
                    } else if (ete > 0) {
                        const etePercentage = Math.min((ete / initialETE) * 100, 100);
                        console.log('ETE Percentage:', etePercentage);
                        eteBar.style.width = etePercentage + '%';
                        eteBar.style.opacity = 1;
                    } else {
                        eteBar.style.width = '0%';
                        eteBar.style.opacity = 0;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching ETE data:', error);
                // Set opacity to 0 if fetching data fails
                const eteBar = document.getElementById('ete-bar');
                if (eteBar) {
                    eteBar.style.width = '0%';
                    eteBar.style.opacity = 0;
                }
            });
    }

    function sortTable(columnIndex, dir = 'asc') {
        var table = document.getElementById("flightTable");
        var rows = table.rows;
        var switching = true;
        var shouldSwitch, i;
        var switchcount = 0;

        // Clear existing sort indicators
        var headers = table.getElementsByTagName("th");
        for (i = 0; i < headers.length; i++) {
            headers[i].classList.remove("sort-asc", "sort-desc");
        }

        while (switching) {
            switching = false;
            var rowsArray = Array.prototype.slice.call(rows, 2); // Skip the header row and the green bar row

            for (i = 0; i < rowsArray.length - 1; i++) {
                shouldSwitch = false;
                var x = rowsArray[i].getElementsByTagName("TD")[columnIndex];
                var y = rowsArray[i + 1].getElementsByTagName("TD")[columnIndex];

                if (dir == "asc") {
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (dir == "desc") {
                    if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }

            if (shouldSwitch) {
                rowsArray[i].parentNode.insertBefore(rowsArray[i + 1], rowsArray[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }

        // Add sort indicator to the sorted column header
        if (dir == "asc") {
            headers[columnIndex].classList.add("sort-asc");
        } else {
            headers[columnIndex].classList.add("sort-desc");
        }

        // Save sort state
        localStorage.setItem('sortColumnIndex', columnIndex);
        localStorage.setItem('sortDirection', dir);
    }

    function initialize() {
        // Restore sort state
        var sortColumnIndex = localStorage.getItem('sortColumnIndex');
        var sortDirection = localStorage.getItem('sortDirection');
        if (sortColumnIndex !== null && sortDirection !== null) {
            sortTable(parseInt(sortColumnIndex), sortDirection);
        } else {
            // Default sort by Flight Status on first load
            sortTable(3, 'asc');
        }

        // Fetch initial ETE value
        fetchInitialETE();

        // Automatically sort by Flight Status every 2000 milliseconds
        setInterval(function() {
            sortTable(3, localStorage.getItem('sortDirection') || 'asc'); // Sort by Flight Status (column index 3)
            updateETEbars();
        }, 2000);

        // Refresh the entire page every 2000 milliseconds
        setInterval(function() {
            location.reload();
        }, 2000);
    }

    initialize();
});
</script>
<style>
body { font-family: Arial, sans-serif; 
background-color: rgb(100, 100, 100); /* Set the background color to RGB(100, 100, 100) */
color: white; /* Optional: Set the text color to white for better contrast */} 
table { width: 100%; }
th, td { text-align: center; position: relative; }
.blinking { animation: blinker 2s linear infinite; }
@keyframes blinker { 50% { background-color: transparent; } }
th.sort-asc:after {
    content: " ▲";
}
th.sort-desc:after {
    content: " ▼";
}
.ete-bar-container {
    position: relative;
    height: 20px;
    background-color: rgba(0, 0, 0, 0.2);
    z-index: 1;
}
.ete-bar {
    height: 100%;
    background-color: green;
    opacity: 0; /* Default opacity to 0 */
    float: right; /* Add this line */
}
</style>
</head>
<body>
<table id="flightTable" border='1'>
<tr><th onclick="sortTable(0)">Aircraft</th>
    <th>Flight Number</th>
    <th>Departure/Location</th>
    <th onclick="sortTable(3)">Flight Status</th>
    <th>Destination</th>
</tr>
<tr><td colspan="5" class="ete-bar-container">
	<div class="ete-bar" id="ete-bar" style="width: 0%;"/div>
    </td>
</tr>
<tr><td style='text-align: center;'><img src='https://raw.githubusercontent.com/FlyingKimbo/Flight-Info-Board/main/Aircraft_Type/Concorde.png' alt='Aircraft Image' style='width:100px;height:auto;'> Concorde</td>
    <td>KIMBO707</td>
    <td class='' style=''>VIDP Indira Gandhi International, Delhi </td>
    <td class='' style=''>-</td>
    <td class='' style=''>-</td>
</tr>
<tr><td style='text-align: center;'><img src='https://raw.githubusercontent.com/FlyingKimbo/Flight-Info-Board/main/Aircraft_Type/Concorde.png' alt='Aircraft Image' style='width:100px;height:auto;'> Concorde</td>
    <td>KIMBO706</td>
    <td class='' style=''>LEIB Ibiza </td>
    <td class='' style=''>-</td>
    <td class='' style=''>-</td>
</tr>
<tr><td style='text-align: center;'><img src='https://raw.githubusercontent.com/FlyingKimbo/Flight-Info-Board/main/Aircraft_Type/Boeing748.png' alt='Aircraft Image' style='width:100px;height:auto;'> Boeing748</td>
    <td>KIMBO702</td>
    <td class='' style=''>KJFK Kennedy, New York </td>
    <td class='' style=''>-</td>
    <td class='' style=''>-</td>
</tr>
<tr><td style='text-align: center;'><img src='https://raw.githubusercontent.com/FlyingKimbo/Flight-Info-Board/main/Aircraft_Type/Longitude.png' alt='Aircraft Image' style='width:100px;height:auto;'> Longitude</td>
<td>KIMBO701</td>
<td class='' style=''>LEIB Ibiza </td>
<td class='blinking' style='background-color:lightblue;'>Deboarding</td>
<td class='blinking' style='background-color:lightblue;'>KSAN San Diego Intl</td>
</tr>
</table>
</body>
</html>
